<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Primary Meta Tags -->
        <title>Lars Erik Schonander</title>
        <meta name="title" content="Lars Erik Schonander">
        <meta name="description" content="Personal writing, links, and other miscellanea by Lars Erik Schonander. ">

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://www.larserikschonander.com/">
        <meta property="og:title" content="Lars Erik Schonander">
        <meta property="og:description" content="Personal writing, links, and other miscellanea by Lars Erik Schonander. ">
        <meta property="og:image" content>

        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image">
        <meta property="twitter:url" content="https://www.larserikschonander.com/">
        <meta property="twitter:title" content="Lars Erik Schonander">
        <meta property="twitter:description" content="Personal writing, links, and other miscellanea by Lars Erik Schonander. ">
        <meta property="twitter:image" content>
        <link rel="stylesheet" href="../css/default.css" />
        <link rel="shortcut icon" href="../images/icon_HSn_icon.ico" type="image/x-icon" />
        <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-121467707-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-121467707-1');
    </script>
    </head>
    <body>  
        <h1 id="name">Lars E. Schonander</h1>
        <header>
                <a href="../">Home</a>
                <a href="../about.html">About</a>
                <a href="../contact.html">Contact</a>
                <a href="../archive.html">Archive</a>
            
        </header>

        <main role="main">
            <h1>An Introduction to Purr</h1>
            <article>
    <section class="header">
        Posted on August 27, 2019
        
    </section>
    <section>
        <p>Within <code>R</code> and the <code>Tidyverse</code>, one of the more interesting packages available is <a href="https://purrr.tidyverse.org/">Purr</a>. While much of the Tidyverse is based on functional programming principles, Purr’s focus is on traditional functional programming tools, such as map, reduce, and working in a functional manner with lists.</p>
<h2 id="the-humble-map">The Humble Map</h2>
<p>Like in many languages, <code>Purr</code> provides the class <code>map</code> function. What map does is apply a function over a list of data, from the column of a dataframe, to a list of numbers, or a iteration of numbers.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">library</span>(purrr)</a>
<a class="sourceLine" id="cb1-2" title="2"></a>
<a class="sourceLine" id="cb1-3" title="3">square &lt;-<span class="st"> </span><span class="cf">function</span>(x){x <span class="op">**</span><span class="st"> </span><span class="dv">2</span>}</a>
<a class="sourceLine" id="cb1-4" title="4"><span class="dv">1</span><span class="op">:</span><span class="dv">5</span> <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="st">    </span><span class="kw">map</span>(., square)</a>
<a class="sourceLine" id="cb1-6" title="6"><span class="co"># 1, 4, 9, 16, 25</span></a></code></pre></div>
<p>Using map to multiply numbers is only a basic example of what Purr can do. For example, imagine one is working with the function with the function below.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">get_information &lt;-<span class="st"> </span><span class="cf">function</span>(ID){</a>
<a class="sourceLine" id="cb2-2" title="2">  url &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;https://policecrime.bgsu.edu/Cases/Details/&quot;</span> , ID, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb2-3" title="3">  page &lt;-<span class="st"> </span><span class="kw">read_html</span>(url)</a>
<a class="sourceLine" id="cb2-4" title="4">  </a>
<a class="sourceLine" id="cb2-5" title="5">  <span class="co"># Officer Info</span></a>
<a class="sourceLine" id="cb2-6" title="6">  ArrestedOfficer &lt;-<span class="st"> </span>page <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="st">    </span><span class="kw">html_nodes</span>(<span class="dt">xpath =</span> <span class="st">'/html/body/div[2]/div/div[1]/div[2]'</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-8" title="8"><span class="st">    </span><span class="kw">html_text</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="st">    </span><span class="kw">str_replace_all</span>(<span class="dt">pattern =</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot; &quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-10" title="10"><span class="st">    </span><span class="kw">str_trim</span>()</a>
<a class="sourceLine" id="cb2-11" title="11">    </a>
<a class="sourceLine" id="cb2-12" title="12">  <span class="co"># ... More code like the above below</span></a>
<a class="sourceLine" id="cb2-13" title="13">}</a></code></pre></div>
<p>With Purr and the creation of the function, the Map function along with compact and reduce, can be used to combine the results of multiple page requests from the <code>Rvest</code> package, into a single dataframe.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">alc_crime<span class="op">$</span>ID <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="st">  </span><span class="kw">map</span>(. , get_information) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="st">  </span><span class="kw">compact</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="st">  </span><span class="kw">reduce</span>(bind_rows) -&gt;<span class="st"> </span>df</a></code></pre></div>
<p>When doing web scraping, using map across multiple URL where one knows the xpath or CSS structure is the same can make it a lot easier to aggregate a lot of data into a single dataframe.</p>
<h2 id="maps-friends">Maps Friends</h2>
<p>While the map can often solve many functional data analysis problems, sometimes more complex methods are required. For example, what if you have <em>two</em> inputs to the function that you intend to iterate over?</p>
<p>There are two versions of this problem, one where the 2nd input remains constant, and one where the 2nd input is also a vector as well. In both cases, the Purr function <code>map2</code> can be used, albeit in slightly different ways.</p>
<p>Both situations are illustrated below.</p>
<p>Dealing with the 2nd input being constant.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="dv">1</span><span class="op">:</span><span class="dv">190</span> <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="st">  </span><span class="kw">map2</span>(., <span class="st">&quot;2017-02-23&quot;</span> , get_guardian_content_date) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="st">  </span><span class="kw">compact</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="st">  </span><span class="kw">reduce</span>(bind_rows) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="st">  </span><span class="kw">dbAppendTable</span>(conn, <span class="st">&quot;Guardian_data&quot;</span>, .)</a></code></pre></div>
<p>Dealing with the 2nd input also being a vector.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">mult &lt;-<span class="st"> </span><span class="cf">function</span>(x, y){x <span class="op">*</span><span class="st"> </span>y}</a>
<a class="sourceLine" id="cb5-2" title="2">a &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">5</span></a>
<a class="sourceLine" id="cb5-3" title="3">b &lt;-<span class="st"> </span><span class="dv">5</span><span class="op">:</span><span class="dv">9</span></a>
<a class="sourceLine" id="cb5-4" title="4"></a>
<a class="sourceLine" id="cb5-5" title="5"><span class="kw">map2</span>(a, b mult)</a></code></pre></div>
<p>In this latter case, it is important to ensure the length of the two vectors being used in the function are of equal length, otherwise the function won’t work.</p>
<h2 id="a-few-extras">A Few Extras</h2>
<p>Purr also comes with quite a few utility functions that make working with functions and lists less difficult.</p>
<p><code>Unnest</code>, is a Purr function that unnests a list, and creates a row in a dataframe for each item in the list. This can be useful for extracting list items to count them properly, or to extract dataframes that might be contained in dataframes.</p>
<p>For example, I was working on dataset of all the dogs in the Soviet Space program. To get the list of each different rocket they were on I had to do this.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">soviet_dogs <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="st">  </span><span class="kw">unnest</span>(RocketList) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(RocketList) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="st">  </span><span class="kw">count</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-5" title="5"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">amount =</span> n) -&gt;<span class="st"> </span>rocket_count</a></code></pre></div>
<p><code>Safely</code> is also a very interesting function. What safely does is it acts like a wrapper for another function, ensuring that it only returns valid results. For example, instead of an entire function call failing because a few webpages are down and unable to be scraped, the pages able to be scraped will be called, and the other failures will be stored in a separate dataframe.</p>
<h2 id="conclusion">Conclusion</h2>
<p>What have we learned about some of the benefits of Purr?</p>
<ul>
<li><strong>Tidy Functional Programming:</strong> Notice that all the purr functions will fit easily into a regular tidyverse workflow. One could do a unnest, and then do the usual <code>group_by</code> operation to work with the newly unnested data.</li>
</ul>
<p>Have fun with Purr!</p>
    </section>
</article>

        </main>

        <footer>
            Site proudly built with 
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
            <br>
            Follow me at:
            <a href="https://twitter.com/LarsESchonander">@LarsESchonander</a>
        </footer>
    </body>
</html>
