<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Primary Meta Tags -->
        <title>Lars Erik Schonander</title>
        <meta name="title" content="Lars Erik Schonander">
        <meta name="description" content="Personal writing, links, and other miscellanea by Lars Erik Schonander. ">

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://www.larserikschonander.com/">
        <meta property="og:title" content="Lars Erik Schonander">
        <meta property="og:description" content="Personal writing, links, and other miscellanea by Lars Erik Schonander. ">
        <meta property="og:image" content>

        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image">
        <meta property="twitter:url" content="https://www.larserikschonander.com/">
        <meta property="twitter:title" content="Lars Erik Schonander">
        <meta property="twitter:description" content="Personal writing, links, and other miscellanea by Lars Erik Schonander. ">
        <meta property="twitter:image" content>
        <link rel="stylesheet" href="../css/default.css" />
        <link rel="shortcut icon" href="../images/icon_HSn_icon.ico" type="image/x-icon" />
        <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-121467707-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-121467707-1');
    </script>
    </head>
    <body>  
        <h1 id="name">Lars E. Schonander</h1>
        <header>
                <a href="../">Home</a>
                <a href="../about.html">About</a>
                <a href="../graphics.html">Graphics</a>
                <a href="../contact.html">Contact</a>
                <a href="../archive.html">Archive</a>
            
        </header>

        <main role="main">
            <h1>Simulation in R</h1>
            <article>
    <section class="header">
        Posted on August 20, 2019
        
    </section>
    <section>
        <p>I recently been enjoying learning more about probability in R, reading David Robinson’s book <a href="http://varianceexplained.org/r/empirical-bayes-book/">Introduction to Empirical Bayes</a>. The book primarily teaches the usage of Bayesian statistics by using baseball statistics.</p>
<p>However, a theme in the book and also the authors blog posts is also using R for simulation, which is very helpful when doing work related to probabilities and is the basis of Markov Chain Monte Carlo, an advanced method of simulation.</p>
<p>In this post however, I’ll go over how to do some basic simulation work using <code>R</code> and the <code>Tidyverse</code>.</p>
<h3 id="simulating-coin-tosses">Simulating coin tosses</h3>
<p>Via the usage of simulation over a long period of trials, one can approximate the probability of a action, in this case coin flips.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">tibble</span>(<span class="dt">trial =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">100000</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1-2" title="2">	<span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb1-3" title="3">            <span class="dt">coinflip =</span> <span class="kw">sample</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="kw">n</span>(), <span class="dt">replace =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb1-4" title="4">            <span class="dt">average =</span> <span class="kw">cummean</span>(coinflip)</a>
<a class="sourceLine" id="cb1-5" title="5">        ) -&gt;<span class="st"> </span>coinFlips</a></code></pre></div>
<p>In this case, we a are simulating the flip of a coin, with heads being 0, tails being 1, with flips being done 100,000 times. The average in this case represents the cumulative mean of the coin flips overtime, which after many flips will approximate the probability of the action.</p>
<p>This is known as the <a href="https://en.wikipedia.org/wiki/Law_of_large_numbers">Law of Large Numbers</a>, which states that the average calculated from the result of all the trials should get closer to the expected value as more trials are done.</p>
<p>This can be visualized as well.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">coinFlips <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(trial, average)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="st">    </span><span class="kw">geom_line</span>()</a></code></pre></div>
<p><img class="imgContent" src="../images/CoinFlipChart.png" style="width:400px;height:400px;  display: block;margin-left: auto;margin-right: auto;" /></p>
<p>The Law of Large Numbers can also be displayed again, when with <code>R</code> one sets the probabilities for a sequence of numbers, and then runs many trials.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">tibble</span>(<span class="dt">trial =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">100000</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-2" title="2">	<span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb3-3" title="3">            <span class="dt">number =</span> <span class="kw">sample</span>(<span class="kw">seq</span>(<span class="dv">1</span>, <span class="dv">4</span>), <span class="kw">n</span>(), </a>
<a class="sourceLine" id="cb3-4" title="4">            <span class="dt">prob =</span> <span class="kw">c</span>(<span class="fl">0.35</span>, <span class="fl">0.15</span>, <span class="fl">0.4</span>, <span class="fl">.1</span>), <span class="dt">replace =</span> T)</a>
<a class="sourceLine" id="cb3-5" title="5">) -&gt;<span class="st"> </span>trials</a>
<a class="sourceLine" id="cb3-6" title="6"></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="co"># grouping to show the probabilities for each number</span></a>
<a class="sourceLine" id="cb3-8" title="8">trials <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb3-9" title="9"><span class="st">    </span><span class="kw">group_by</span>(number) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb3-10" title="10"><span class="st">    </span><span class="kw">count</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb3-11" title="11"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">prob =</span> n <span class="op">/</span><span class="st"> </span><span class="dv">100000</span>)</a></code></pre></div>
<p>Below is a table based on the code above.</p>
<table>
<thead>
<tr class="header">
<th>Number</th>
<th style="text-align: center;">Count</th>
<th style="text-align: center;">Probability</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td style="text-align: center;">35117</td>
<td style="text-align: center;">0.351</td>
</tr>
<tr class="even">
<td>2</td>
<td style="text-align: center;">14976</td>
<td style="text-align: center;">0.150</td>
</tr>
<tr class="odd">
<td>3</td>
<td style="text-align: center;">39920</td>
<td style="text-align: center;">0.399</td>
</tr>
<tr class="even">
<td>4</td>
<td style="text-align: center;">9987</td>
<td style="text-align: center;">0.0999</td>
</tr>
</tbody>
</table>
<p>As seen with the probabilities created, they hew very closely to the probabilities inputted at the beginning, showing again how the Law of Large Numbers lets one approach the expected value over many trials.</p>
<h3 id="monte-carlo">Monte Carlo</h3>
<p>The same methods can be used to run <a href="https://en.wikipedia.org/wiki/Monte_Carlo_method">Monte Carlo</a> experiments, which is very useful when dealing with problems regarding probability distributions.</p>
<p>For example, lets answer the following question.</p>
<blockquote>
<p>In this game landing on <em>yellow</em> earns 1 point, <em>red</em> loses 1 point and <em>blue</em> earns 2 points. What is the probability of a negative score after 10 spins? The wheel is YYRB for reference.</p>
</blockquote>
<p>By hand, this would be a very tedious problem, however in R, we can not only run many trials, but also simulate all the turns as well, and not even use a nested <code>for loop</code>!</p>
<p>To begin, the R code to simulate all the wheel spins.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">crossing</span>(<span class="dt">trial =</span> <span class="dv">1</span><span class="op">:</span><span class="fl">1e5</span>, <span class="dt">turn =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-2" title="2">	<span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb4-3" title="3">        <span class="dt">results =</span> <span class="kw">sample</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">2</span>), <span class="kw">n</span>(), <span class="dt">replace =</span> T)</a>
<a class="sourceLine" id="cb4-4" title="4">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-5" title="5">	<span class="kw">group_by</span>(trial) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-6" title="6">	<span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb4-7" title="7">	<span class="dt">wheelSum =</span> <span class="kw">cumsum</span>(results)</a>
<a class="sourceLine" id="cb4-8" title="8">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-9" title="9"><span class="st">    </span><span class="kw">ungroup</span>() -&gt;<span class="st"> </span>spins</a></code></pre></div>
<p>What <code>crossing</code> does is it will in this case create a 1:1e5x10 dataframe, meaning each trial has 10 turns, so in practice there will be a million rows in the dataframe.</p>
<p>Next, we take a sample for each turn. However, to get the cumulative result, we need to group by trial, so each 1:10 period has its own cumulative sum.</p>
<p>After this, we can then look at the 10th spin to see the probability of a negative spin.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">spins <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-2" title="2">	<span class="kw">filter</span>(turn <span class="op">==</span><span class="st"> </span><span class="dv">10</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-3" title="3">	<span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(wheelSum <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>, <span class="st">&quot;Negative&quot;</span>, <span class="st">&quot;Positive&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-4" title="4">	<span class="kw">group_by</span>(value) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-5" title="5">	<span class="kw">count</span>() -&gt;<span class="st"> </span>values</a>
<a class="sourceLine" id="cb5-6" title="6"></a>
<a class="sourceLine" id="cb5-7" title="7"><span class="co"># Then divide by the values given</span></a>
<a class="sourceLine" id="cb5-8" title="8">values[<span class="dv">1</span>, <span class="dv">2</span>]  <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(values<span class="op">$</span>n) <span class="co"># 0.01271</span></a></code></pre></div>
<p>We first filter to ensure we get only the results from the 10th spin, then we split the dataframe between sums that were negative versus positive. Finally, we count the values divide the negative values by the sum of both negative and positive values, giving us our probability.</p>
<p>While a toy example, there are some problems, particularly in finance, which require Monte Carlo methods to solve.</p>
<p>Have fun trying these techniques out!</p>
    </section>
</article>

        </main>

        <footer>
            Site proudly built with 
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
            <br>
            Follow me at:
            <a href="https://twitter.com/LarsESchonander">@LarsESchonander</a>
        </footer>
    </body>
</html>
